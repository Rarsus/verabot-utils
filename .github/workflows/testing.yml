name: Testing - Unit & Integration

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  unit-tests-node20:
    name: "Unit Tests (Node 20.x)"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ§ª Run unit tests
        id: test
        run: |
          npm run test -- \
            --coverage \
            --collectCoverageFrom='src/**/*.js' \
            --collectCoverageFrom='!src/**/*.test.js' \
            --json \
            --outputFile=test-results-node20.json \
            2>&1 | tee test-output-node20.txt
          
          TEST_EXIT_CODE=$?
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Extract test counts
          PASS_COUNT=$(grep -oP '\d+(?= passed)' test-output-node20.txt | head -1 || echo "0")
          FAIL_COUNT=$(grep -oP '\d+(?= failed)' test-output-node20.txt | head -1 || echo "0")
          echo "passed=${PASS_COUNT}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL_COUNT}" >> $GITHUB_OUTPUT
          
          exit 0

      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests-node20
          name: unit-tests-node20
          fail_ci_if_error: false

      - name: âŒ Fail if tests failed
        if: steps.test.outputs.exit_code != 0
        run: exit 1

  unit-tests-node22:
    name: "Unit Tests (Node 22.x)"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ§ª Run unit tests
        id: test
        run: |
          npm run test -- \
            --coverage \
            --collectCoverageFrom='src/**/*.js' \
            --collectCoverageFrom='!src/**/*.test.js' \
            --json \
            --outputFile=test-results-node22.json \
            2>&1 | tee test-output-node22.txt
          
          TEST_EXIT_CODE=$?
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Extract test counts
          PASS_COUNT=$(grep -oP '\d+(?= passed)' test-output-node22.txt | head -1 || echo "0")
          FAIL_COUNT=$(grep -oP '\d+(?= failed)' test-output-node22.txt | head -1 || echo "0")
          echo "passed=${PASS_COUNT}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL_COUNT}" >> $GITHUB_OUTPUT
          
          exit 0

      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests-node22
          name: unit-tests-node22
          fail_ci_if_error: false

      - name: âŒ Fail if tests failed
        if: steps.test.outputs.exit_code != 0
        run: exit 1

  coverage-check:
    name: "Coverage Threshold Check (90%+)"
    runs-on: ubuntu-latest
    needs: [unit-tests-node20, unit-tests-node22]
    if: always() && needs.unit-tests-node20.result == 'success' && needs.unit-tests-node22.result == 'success'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ“Š Verify coverage thresholds (Higher Standard)
        run: |
          npm run test -- --coverage --silent > /dev/null 2>&1 || true
          
          # Parse coverage thresholds
          LINES=$(grep -oP 'Lines\s+:\s+\K[\d.]+' coverage/coverage-summary.json || echo "0")
          FUNCTIONS=$(grep -oP 'Functions\s+:\s+\K[\d.]+' coverage/coverage-summary.json || echo "0")
          BRANCHES=$(grep -oP 'Branches\s+:\s+\K[\d.]+' coverage/coverage-summary.json || echo "0")
          
          echo "ðŸ“Š Coverage Summary (Shared Utilities):"
          echo "   Lines:     ${LINES}% (target: 90%+)"
          echo "   Functions: ${FUNCTIONS}% (target: 95%+)"
          echo "   Branches:  ${BRANCHES}% (target: 85%+)"
          
          # Check thresholds (Higher standards for utilities)
          if (( $(echo "$LINES < 90" | bc -l) )); then
            echo "âŒ Lines coverage below 90% threshold"
            exit 1
          fi
          
          if (( $(echo "$FUNCTIONS < 95" | bc -l) )); then
            echo "âŒ Functions coverage below 95% threshold"
            exit 1
          fi
          
          if (( $(echo "$BRANCHES < 85" | bc -l) )); then
            echo "âŒ Branches coverage below 85% threshold"
            exit 1
          fi
          
          echo "âœ… All coverage thresholds met"
